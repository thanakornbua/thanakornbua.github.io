<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Presenter View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="app.css" />
    <script>
      (() => {
        const key = 'theme';
        let stored = null;
        try {
          stored = localStorage.getItem(key);
        } catch (err) {
          stored = null;
        }
        const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (preferDark ? 'dark' : 'light');
        document.documentElement.dataset.theme = theme;
      })();
    </script>
  </head>
  <body class="page">
    <div class="backdrop" aria-hidden="true">
      <div class="orb one"></div>
      <div class="orb two"></div>
      <div class="orb three"></div>
      <div class="gridOverlay"></div>
    </div>

    <div class="container content">
      <header class="header">
        <div class="brand">
          <h1>Presenter View</h1>
          <p>Current + next slide with timer and notes</p>
        </div>
        <div class="nav">
          <button id="prev" type="button" class="btn">Prev</button>
          <button id="next" type="button" class="btn">Next</button>
          <div class="small" id="pageInfo">Page 0 / 0</div>
          <div class="small" id="timer">00:00</div>
          <button id="close" type="button" class="btn">Close</button>
          <button id="themeToggle" type="button" class="btn" aria-label="Toggle theme">
            <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4" width="16" height="16">
              <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" />
              <path fill-rule="evenodd" d="M12 1.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V2a.75.75 0 0 1 .75-.75ZM3.49 3.49a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 1 1-1.06 1.06L3.49 4.55a.75.75 0 0 1 0-1.06ZM21.25 12a.75.75 0 0 1-.75.75H19a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75ZM5 12a.75.75 0 0 1-.75.75H2.75a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 5 12Zm14.45-8.51a.75.75 0 0 1 1.06 1.06l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06ZM12 19.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V20a.75.75 0 0 1 .75-.75ZM4.55 18.39a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 1 1-1.06 1.06l-1.06-1.06a.75.75 0 0 1 0-1.06Zm13.78 0a.75.75 0 0 1 1.06 1.06l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06Z" clip-rule="evenodd" />
            </svg>
            <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4" width="16" height="16">
              <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6.75a9 9 0 0 0 9 9 8.97 8.97 0 0 0 4.213-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.97 2.196-7.428 5.528-9.282Z" clip-rule="evenodd" />
            </svg>
            <span id="themeLabel">Theme</span>
          </button>
        </div>
      </header>

      <main class="presenterGrid">
        <section class="presenterPanel">
          <h2>Current slide</h2>
          <canvas id="cur" class="presenterCanvas"></canvas>
        </section>
        <section class="presenterPanel">
          <h2>Next slide</h2>
          <canvas id="nxt" class="presenterCanvas"></canvas>
        </section>
      </main>

      <section class="presenterPanel" style="margin-top:12px;">
        <h2>Notes</h2>
        <textarea id="notes" placeholder="Presenter notes (saved in this browser)…"></textarea>
        <div class="small" style="margin-top:8px;">Tip: keep this window on a second screen.</div>
      </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      (() => {
        const btn = document.getElementById('themeToggle');
        if (!btn) return;
        const iconSun = document.getElementById('iconSun');
        const iconMoon = document.getElementById('iconMoon');
        const label = document.getElementById('themeLabel');
        const storageKey = 'theme';
        const prefersDarkMedia = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

        const readStored = () => {
          try {
            return localStorage.getItem(storageKey);
          } catch (err) {
            return null;
          }
        };
        const writeStored = (value) => {
          try {
            localStorage.setItem(storageKey, value);
          } catch (err) {
            // ignore write errors
          }
        };

        const apply = (theme, options = {}) => {
          const next = theme === 'dark' ? 'dark' : 'light';
          document.documentElement.dataset.theme = next;
          if (options.persist !== false) {
            writeStored(next);
          }
          const isDark = next === 'dark';
          if (iconSun) iconSun.style.display = isDark ? 'inline-block' : 'none';
          if (iconMoon) iconMoon.style.display = isDark ? 'none' : 'inline-block';
          if (label) label.textContent = isDark ? 'Dark' : 'Light';
          btn.setAttribute('aria-pressed', String(isDark));
        };

        const initial = readStored() || (prefersDarkMedia && prefersDarkMedia.matches ? 'dark' : 'light');
        apply(initial, { persist: false });

        btn.addEventListener('click', () => {
          const isDark = document.documentElement.dataset.theme === 'dark';
          apply(isDark ? 'light' : 'dark');
        });

        if (prefersDarkMedia) {
          prefersDarkMedia.addEventListener('change', (event) => {
            if (readStored()) return;
            apply(event.matches ? 'dark' : 'light', { persist: false });
          });
        }
      })();

      const params = new URLSearchParams(location.search);
      const srcUrl = params.get('src');
      const initialPage = Number(params.get('page') || '1');
      const metaDate = params.get('date') || '';
      const metaCode = params.get('code') || '';

      const curCanvas = document.getElementById('cur');
      const nxtCanvas = document.getElementById('nxt');
      const timerEl = document.getElementById('timer');
      const notesEl = document.getElementById('notes');
      const prevEl = document.getElementById('prev');
      const nextEl = document.getElementById('next');
      const pageInfoEl = document.getElementById('pageInfo');
      document.getElementById('close').addEventListener('click', () => window.close());

      if (!srcUrl) {
        document.body.innerHTML = '<div style="padding:16px;font-family:system-ui;color:white;background:black">Missing src</div>';
        throw new Error('Missing src');
      }
      if (!window.pdfjsLib) {
        document.body.innerHTML = '<div style="padding:16px;font-family:system-ui;color:white;background:black">PDF.js failed to load</div>';
        throw new Error('PDF.js failed to load');
      }

      const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('pdf-presenter') : null;

      const workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;

      const notesKey = `notes:${srcUrl}`;
      notesEl.value = localStorage.getItem(notesKey) || '';
      notesEl.addEventListener('input', () => localStorage.setItem(notesKey, notesEl.value));

      let pdf = null;
      let page = Math.max(1, initialPage);
      let total = 0;
      let rendering = false;

      const meta = document.createElement('div');
      meta.className = 'metaOverlay';
      meta.textContent = [metaDate ? `Date: ${metaDate}` : '', metaCode ? `Code: ${metaCode}` : ''].filter(Boolean).join('  •  ');
      if (meta.textContent) document.body.appendChild(meta);

      function startTimer() {
        const started = Date.now();
        setInterval(() => {
          const s = Math.floor((Date.now() - started) / 1000);
          const mm = String(Math.floor(s / 60)).padStart(2, '0');
          const ss = String(s % 60).padStart(2, '0');
          timerEl.textContent = `${mm}:${ss}`;
        }, 250);
      }

      async function renderTo(canvasEl, pageNumber) {
        const p = await pdf.getPage(Math.max(1, Math.min(pdf.numPages, pageNumber)));
        const viewport = p.getViewport({ scale: 0.42 });
        canvasEl.width = Math.floor(viewport.width);
        canvasEl.height = Math.floor(viewport.height);
        const ctx = canvasEl.getContext('2d', { alpha: false });
        await p.render({ canvasContext: ctx, viewport }).promise;
      }

      async function rerender() {
        if (!pdf || rendering) return;
        rendering = true;
        try {
          await renderTo(curCanvas, page);
          await renderTo(nxtCanvas, Math.min(pdf.numPages, page + 1));
          pageInfoEl.textContent = `Page ${page} / ${pdf.numPages}`;
        } finally {
          rendering = false;
        }
      }

      function clampPage(n) {
        if (!pdf) return 1;
        return Math.max(1, Math.min(pdf.numPages, n));
      }

      async function gotoPage(next) {
        if (!pdf) return;
        page = clampPage(next);
        await rerender();
        if (bc) bc.postMessage({ type: 'goto', page, src: srcUrl });
      }

      prevEl.addEventListener('click', () => gotoPage(page - 1));
      nextEl.addEventListener('click', () => gotoPage(page + 1));

      window.addEventListener('keydown', (e) => {
        if (e.target && ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
        if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') {
          e.preventDefault();
          gotoPage(page + 1);
        } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
          e.preventDefault();
          gotoPage(page - 1);
        }
      });

      (async () => {
        pdf = await window.pdfjsLib.getDocument({ url: srcUrl }).promise;
        total = pdf.numPages;
        page = clampPage(page);
        await rerender();
        startTimer();
      })();
    </script>
  </body>
</html>
