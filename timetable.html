<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Timetable Viewer - TCAS70</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kanit:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-white">
  <div id="app" class="relative min-h-screen" >
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed glass px-3 py-6 border border-slate-800/70 flex flex-col md:flex-col items-center md:items-start gap-3 z-40 no-print">
      <div class="w-full flex items-center justify-between gap-2 text-white font-semibold text-sm md:text-base">
        <div class="flex items-center gap-2">
          <span class="text-neonBlue">//</span>
          <span class="hidden md:inline">UTILITY</span>
        </div>
        <button id="sidebar-close" class="text-slate-400 hover:text-white text-xl leading-none" aria-label="Close sidebar">√ó</button>
      </div>
      <nav class="flex flex-row md:flex-col gap-2 w-full">
        <a href="index.html" class="glass px-3 py-2 rounded-lg border border-slate-700/70 text-white hover:border-neonBlue transition text-center">üè†<span class="hidden md:inline ml-1">Dashboard</span></a>
        <a href="timer.html" class="glass px-3 py-2 rounded-lg border border-slate-700/70 text-white hover:border-neonBlue transition text-center">‚è±<span class="hidden md:inline ml-1">Timer</span></a>
        <a href="timetable.html" class="glass px-3 py-2 rounded-lg border border-neonBlue text-white transition text-center">üìÖ<span class="hidden md:inline ml-1">Timetable</span></a>
        <a href="credits.html" class="glass px-3 py-2 rounded-lg border border-slate-700/70 text-white hover:border-neonBlue transition text-center">üìú<span class="hidden md:inline ml-1">Credits</span></a>
      </nav>
    </aside>
    <!-- Sidebar FAB -->
    <button id="sidebar-open" class="no-print sidebar-fab glass px-3 py-2 rounded-lg border border-slate-700/70 text-white hover:border-neonBlue transition" aria-label="Open sidebar">‚ò∞</button>

    <main id="main" class="relative max-w-6xl mx-auto px-4 md:px-8 py-8">
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Schedule</p>
          <h1 class="text-3xl md:text-4xl font-[Kanit] font-bold">Timetable Viewer</h1>
          <p class="text-slate-300 text-sm md:text-base max-w-2xl mt-2">
            Select your section to view the timetable. You can export the timetable for offline use.
          </p>
        </div>
        <div class="glass rounded-2xl border border-slate-800/80 p-4 space-y-3 no-print">
          <div class="space-y-3">
            <div class="space-y-1">
              <label for="section-select" class="block text-xs font-semibold text-slate-300">Section / Class</label>
              <select id="section-select" class="w-full glass border border-slate-700/70 rounded-lg px-3 py-2 bg-slate-900/60 text-white focus:outline-none focus:ring-2 focus:ring-neonPink">
                <option value="" disabled selected>Select section‚Ä¶</option>
              </select>
            </div>
            <div class="space-y-1">
              <label for="date-select" class="block text-xs font-semibold text-slate-300">Override date (optional)</label>
              <input id="date-select" type="date" class="w-full glass border border-slate-700/70 rounded-lg px-3 py-2 bg-slate-900/60 text-white focus:outline-none focus:ring-2 focus:ring-neonBlue" />
              <p class="text-[10px] text-slate-500">Pick a date to apply any date-specific swaps or events.</p>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2 text-xs text-slate-400">
            <span class="uppercase tracking-[0.16em]">View</span>
            <div class="inline-flex rounded-full border border-slate-700/70 bg-slate-900/70 overflow-hidden">
              <button id="view-daily" type="button" class="px-3 py-1 text-xs font-medium bg-slate-100 text-slate-900">Daily</button>
              <button id="view-weekly" type="button" class="px-3 py-1 text-xs font-medium text-slate-300 hover:bg-slate-800/70">Weekly</button>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="export-btn" class="px-4 py-2 rounded-lg border border-slate-700 text-white text-sm">Export as CSV</button>
          </div>
        </div>
      </header>

      <section class="glass rounded-3xl p-6 md:p-8 border border-slate-800/80 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="min-w-0">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Studying now</p>
            <h2 id="current-period-title" class="text-xl md:text-2xl font-semibold truncate">Choose a section to start.</h2>
            <p id="current-period-meta" class="text-slate-400 text-sm mt-1">‚Äî</p>
          </div>
          <div class="text-left md:text-right">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Time left</p>
            <div id="current-period-countdown" class="text-3xl md:text-4xl font-[Kanit] font-bold">‚Äî</div>
            <p id="current-period-countdown-sub" class="text-[10px] text-slate-500">minutes : seconds</p>
          </div>
        </div>

        <div class="mt-5">
          <div class="flex items-center justify-between text-xs text-slate-400">
            <span id="current-period-start">‚Äî</span>
            <span id="current-period-end">‚Äî</span>
          </div>
          <div class="mt-2 h-2 rounded-full bg-slate-800/70 overflow-hidden border border-slate-700/60">
            <div id="current-period-progress" class="h-full w-0" style="background: linear-gradient(90deg, rgba(56, 189, 248, 0.95), rgba(244, 114, 182, 0.85));"></div>
          </div>
        </div>
      </section>

      <section class="glass rounded-3xl p-6 md:p-8 border border-slate-800/80">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl md:text-2xl font-semibold">Current timetable</h2>
            <p id="section-label" class="text-slate-400 text-sm mt-1">No section selected.</p>
          </div>
          <p id="updated-label" class="text-xs text-slate-500 hidden md:block"></p>
        </div>

        <div id="timetable-container" class="overflow-x-auto">
          <table class="min-w-full text-sm text-left border-collapse">
            <thead>
              <tr class="border-b border-slate-700 text-slate-300">
                <th class="py-2 pr-4">Day</th>
                <th class="py-2 pr-4">Start</th>
                <th class="py-2 pr-4">End</th>
                <th class="py-2 pr-4">Subject</th>
                <th class="py-2 pr-4">Teacher</th>
                <th class="py-2 pr-4">Room</th>
                <th class="py-2 pr-4">Status</th>
              </tr>
            </thead>
            <tbody id="timetable-body" class="align-top text-slate-100">
              <tr>
                <td colspan="7" class="py-6 text-center text-slate-400">Choose a section to see its timetable.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Sidebar toggle (reuse existing CSS behavior)
    (function() {
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('sidebar-open');
      const closeBtn = document.getElementById('sidebar-close');

      function openSidebar() {
        sidebar.classList.add('open');
        openBtn.style.display = 'none';
      }
      function closeSidebar() {
        sidebar.classList.remove('open');
        openBtn.style.display = '';
      }

      openBtn.addEventListener('click', openSidebar);
      closeBtn.addEventListener('click', closeSidebar);

      // Open by default on desktop
      if (window.innerWidth >= 769) {
        openSidebar();
      }
    })();

    // Timetable logic
    (function() {
      const sectionSelect = document.getElementById('section-select');
      const sectionLabel = document.getElementById('section-label');
      const updatedLabel = document.getElementById('updated-label');
      const tbody = document.getElementById('timetable-body');
      const exportBtn = document.getElementById('export-btn');
      const dateSelect = document.getElementById('date-select');
      const viewDailyBtn = document.getElementById('view-daily');
      const viewWeeklyBtn = document.getElementById('view-weekly');

      const currentPeriodTitle = document.getElementById('current-period-title');
      const currentPeriodMeta = document.getElementById('current-period-meta');
      const currentPeriodCountdown = document.getElementById('current-period-countdown');
      const currentPeriodStart = document.getElementById('current-period-start');
      const currentPeriodEnd = document.getElementById('current-period-end');
      const currentPeriodProgress = document.getElementById('current-period-progress');

      let sections = [];
      let currentSection = null;
      let overrides = [];
      let currentDate = '';
      let viewMode = 'daily'; // 'daily' | 'weekly'

      let currentPeriodIntervalId = null;

      function parseTimeOnDate(dateOnly, hhmm) {
        if (!dateOnly || !hhmm) return null;
        const parts = String(hhmm).split(':').map(Number);
        const h = parts[0] || 0;
        const m = parts[1] || 0;
        const d = new Date(dateOnly.getFullYear(), dateOnly.getMonth(), dateOnly.getDate(), h, m, 0, 0);
        return isNaN(d.getTime()) ? null : d;
      }

      function formatMinSec(ms) {
        if (ms <= 0) return { mm: '00', ss: '00' };
        const totalSec = Math.floor(ms / 1000);
        const mm = Math.floor(totalSec / 60);
        const ss = totalSec % 60;
        return {
          mm: String(mm).padStart(2, '0'),
          ss: String(ss).padStart(2, '0')
        };
      }

      function updateCurrentPeriodCard() {
        if (!currentPeriodTitle || !currentPeriodCountdown || !currentPeriodProgress) return;

        if (!currentSection) {
          currentPeriodTitle.textContent = 'Choose a section to start.';
          currentPeriodMeta.textContent = '‚Äî';
          currentPeriodCountdown.textContent = '‚Äî';
          currentPeriodStart.textContent = '‚Äî';
          currentPeriodEnd.textContent = '‚Äî';
          currentPeriodProgress.style.width = '0%';
          currentPeriodProgress.style.background = 'linear-gradient(90deg, rgba(56, 189, 248, 0.95), rgba(244, 114, 182, 0.85))';
          return;
        }

        const anchorDate = parseISODateOnly(currentDate) || new Date();
        const now = new Date();
        const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const targetDay = dayNames[anchorDate.getDay()];

        const allowedDates = new Set();
        const iso = toISODateOnly(anchorDate);
        if (iso) allowedDates.add(iso);

        const activeOverrides = (overrides || []).filter(o => {
          if ((o.sectionId || o.id) !== currentSection.id) return false;
          if (o.date && allowedDates.has(String(o.date))) return true;
          return (o.entries || []).some(ovEntry => {
            const d = (ovEntry && ovEntry.date) ? String(ovEntry.date) : (o.date ? String(o.date) : '');
            return d ? allowedDates.has(d) : false;
          });
        });

        const effectiveTimetable = applyOverridesToTimetable(currentSection.timetable || [], activeOverrides, allowedDates);
        const todaysEntries = (effectiveTimetable || [])
          .filter(e => (e.day || '') === targetDay)
          .slice()
          .sort((a, b) => String(a.start || '').localeCompare(String(b.start || '')));

        let active = null;
        for (const entry of todaysEntries) {
          const entryDateForStatus = entry && entry.date
            ? (parseISODateOnly(entry.date) || anchorDate)
            : anchorDate;

          const startDate = parseTimeOnDate(entryDateForStatus, entry.start || '00:00');
          const endDate = parseTimeOnDate(entryDateForStatus, entry.end || entry.start || '00:00');
          if (!startDate || !endDate) continue;

          if (now >= startDate && now <= endDate) {
            active = { entry, startDate, endDate };
            break;
          }
        }

        if (!active) {
          currentPeriodTitle.textContent = 'No active period right now.';
          currentPeriodMeta.textContent = `${targetDay}${currentDate ? ` ‚Ä¢ ${currentDate}` : ''}`;
          currentPeriodCountdown.textContent = '‚Äî';
          currentPeriodStart.textContent = '‚Äî';
          currentPeriodEnd.textContent = '‚Äî';
          currentPeriodProgress.style.width = '0%';
          currentPeriodProgress.style.background = 'linear-gradient(90deg, rgba(56, 189, 248, 0.95), rgba(244, 114, 182, 0.85))';
          return;
        }

        const { entry, startDate, endDate } = active;
        const remainingMs = endDate - now;
        const totalMs = Math.max(1, endDate - startDate);
        const elapsedMs = Math.min(totalMs, Math.max(0, now - startDate));
        const progressPct = Math.max(0, Math.min(100, (elapsedMs / totalMs) * 100));
        const parts = formatMinSec(remainingMs);

        currentPeriodTitle.textContent = entry.subject || 'Current period';
        currentPeriodMeta.textContent = [entry.teacher, entry.room].filter(Boolean).join(' ‚Ä¢ ') || targetDay;
        currentPeriodCountdown.textContent = `${parts.mm}:${parts.ss}`;
        currentPeriodStart.textContent = `${entry.start || ''}`;
        currentPeriodEnd.textContent = `${entry.end || ''}`;
        currentPeriodProgress.style.width = `${progressPct}%`;

        const isActivities = String(entry.status || '').trim().toLowerCase() === 'activities';
        currentPeriodProgress.style.background = isActivities
          ? 'linear-gradient(90deg, rgba(34, 197, 94, 0.95), rgba(16, 185, 129, 0.85))'
          : 'linear-gradient(90deg, rgba(56, 189, 248, 0.95), rgba(244, 114, 182, 0.85))';
      }

      function updateViewToggleButtons() {
        if (!viewDailyBtn || !viewWeeklyBtn) return;
        if (viewMode === 'daily') {
          viewDailyBtn.classList.add('bg-slate-100', 'text-slate-900');
          viewDailyBtn.classList.remove('bg-transparent', 'text-slate-300');
          viewWeeklyBtn.classList.remove('bg-slate-100', 'text-slate-900');
          viewWeeklyBtn.classList.add('bg-transparent', 'text-slate-300');
        } else {
          viewWeeklyBtn.classList.add('bg-slate-100', 'text-slate-900');
          viewWeeklyBtn.classList.remove('bg-transparent', 'text-slate-300');
          viewDailyBtn.classList.remove('bg-slate-100', 'text-slate-900');
          viewDailyBtn.classList.add('bg-transparent', 'text-slate-300');
        }
      }

      function groupByDay(entries) {
        const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const map = new Map();
        entries.forEach(e => {
          const key = e.day || 'Other';
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(e);
        });
        days.forEach(d => {
          if (map.has(d)) {
            map.set(d, map.get(d).sort((a,b) => a.start.localeCompare(b.start)));
          }
        });
        return { order: days.filter(d => map.has(d)).concat(Array.from(map.keys()).filter(k => !days.includes(k))), map };
      }

      function parseISODateOnly(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr + 'T00:00:00');
        return isNaN(d.getTime()) ? null : d;
      }

      function toISODateOnly(d) {
        if (!d || isNaN(d.getTime())) return '';
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function startOfWeekMonday(anchorDate) {
        const d = new Date(anchorDate);
        d.setHours(0, 0, 0, 0);
        const day = d.getDay();
        // JS: 0=Sun..6=Sat. We want Monday as start.
        const diff = day === 0 ? -6 : 1 - day;
        d.setDate(d.getDate() + diff);
        return d;
      }

      function dateForDayName(weekStartMonday, dayName) {
        const offsets = {
          Monday: 0,
          Tuesday: 1,
          Wednesday: 2,
          Thursday: 3,
          Friday: 4,
          Saturday: 5,
          Sunday: 6
        };
        if (!weekStartMonday || !offsets.hasOwnProperty(dayName)) return null;
        const d = new Date(weekStartMonday);
        d.setDate(d.getDate() + offsets[dayName]);
        return d;
      }

      function applyOverridesToTimetable(baseTimetable, activeOverrides, allowedDatesSet) {
        const base = (baseTimetable || []).map(e => Object.assign({}, e));
        if (!activeOverrides || activeOverrides.length === 0) return base;

        activeOverrides.forEach(o => {
          (o.entries || []).forEach(ovEntry => {
            const entryDateStr = (ovEntry && ovEntry.date) ? String(ovEntry.date) : ((o && o.date) ? String(o.date) : '');
            if (allowedDatesSet && allowedDatesSet.size > 0 && entryDateStr && !allowedDatesSet.has(entryDateStr)) {
              return;
            }

            const idx = base.findIndex(b => (b.day || '') === (ovEntry.day || '') && (b.start || '') === (ovEntry.start || ''));
            if (idx >= 0) {
              const merged = Object.assign({}, base[idx], ovEntry);
              if (!merged.overrideTag) merged.overrideTag = o.label || 'Override';
              if (!merged.date && entryDateStr) merged.date = entryDateStr;
              base[idx] = merged;
            } else {
              const added = Object.assign({}, ovEntry);
              if (!added.overrideTag) added.overrideTag = o.label || 'Override';
              if (!added.date && entryDateStr) added.date = entryDateStr;
              base.push(added);
            }
          });
        });

        return base;
      }

      function getDisplayStatus(entry, now, entryDate) {
        const baseStatus = (entry && entry.status) ? String(entry.status) : '';
        const normalizedBase = baseStatus.trim().toLowerCase();

        // Preserve explicit non-default statuses (e.g. Swapped) as-is.
        if (normalizedBase && normalizedBase !== 'scheduled') {
          return baseStatus;
        }

        try {
          if (!entry || !entry.start || !entryDate) {
            return 'Scheduled';
          }

          const startParts = (entry.start || '00:00').split(':').map(Number);
          const endParts = (entry.end || entry.start || '00:00').split(':').map(Number);

          const startDate = new Date(
            entryDate.getFullYear(),
            entryDate.getMonth(),
            entryDate.getDate(),
            startParts[0] || 0,
            startParts[1] || 0
          );

          const endDate = new Date(
            entryDate.getFullYear(),
            entryDate.getMonth(),
            entryDate.getDate(),
            endParts[0] || startParts[0] || 0,
            endParts[1] || startParts[1] || 0
          );

          if (now > endDate) return 'Passed';
          if (now >= startDate && now <= endDate) return 'Ongoing';
        } catch (e) {
          // fall back to scheduled on any error
        }

        return 'Scheduled';
      }

      function renderTable(section, dateStr) {
        tbody.innerHTML = '';
        if (!section || !section.timetable || section.timetable.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="7" class="py-6 text-center text-slate-400">No timetable data for this section.</td>';
          tbody.appendChild(tr);
          sectionLabel.textContent = 'No section selected.';
          updatedLabel.textContent = '';
          updatedLabel.classList.add('hidden');
          return;
        }

        sectionLabel.textContent = section.name + (section.grade ? ' (' + section.grade + ')' : '') + (dateStr ? ' ‚Ä¢ ' + dateStr : '');

        const anchorDate = parseISODateOnly(dateStr) || new Date();
        const weekStart = startOfWeekMonday(anchorDate);

        const allowedDates = new Set();
        if (viewMode === 'weekly') {
          ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].forEach(dn => {
            const dd = dateForDayName(weekStart, dn);
            const iso = toISODateOnly(dd);
            if (iso) allowedDates.add(iso);
          });
        } else {
          const iso = toISODateOnly(anchorDate);
          if (iso) allowedDates.add(iso);
        }

        const activeOverrides = section
          ? (overrides || []).filter(o => {
              if ((o.sectionId || o.id) !== section.id) return false;
              // Support both formats:
              // - override-level date (o.date)
              // - entry-level date (ovEntry.date)
              if (o.date && allowedDates.has(String(o.date))) return true;
              return (o.entries || []).some(ovEntry => {
                const d = (ovEntry && ovEntry.date) ? String(ovEntry.date) : (o.date ? String(o.date) : '');
                return d ? allowedDates.has(d) : false;
              });
            })
          : [];

        if (activeOverrides.length > 0) {
          const labels = activeOverrides.map(o => o.label || 'Override');
          updatedLabel.textContent = 'Template from timetable-data.json with overrides: ' + labels.join(', ');
        } else if (dateStr) {
          updatedLabel.textContent = 'Template from timetable-data.json (no overrides for this date).';
        } else {
          updatedLabel.textContent = 'Loaded from timetable-data.json';
        }
        updatedLabel.classList.remove('hidden');

        const effectiveTimetable = applyOverridesToTimetable(section.timetable, activeOverrides, allowedDates);
        const { order, map } = groupByDay(effectiveTimetable);
        const now = new Date();

        // Keep the top "Studying now" card in sync.
        updateCurrentPeriodCard();

        let daysToRender = order;
        let targetDay = null;
        if (viewMode === 'daily') {
          const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
          targetDay = dayNames[anchorDate.getDay()];
          daysToRender = [targetDay];
        }

        daysToRender.forEach(day => {
          const entries = map.get(day) || [];

          const dayDate = viewMode === 'weekly'
            ? dateForDayName(weekStart, day)
            : anchorDate;

          if (entries.length === 0) {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-800/80';
            tr.innerHTML = `
              <td class="py-2 pr-4 align-top font-semibold">${day}</td>
              <td colspan="6" class="py-2 pr-4 align-top text-slate-400">No classes for this day.</td>
            `;
            tbody.appendChild(tr);
            return;
          }

          entries.forEach((entry, index) => {
            let effectiveEntry = entry;
            let effectiveOverrideTag = entry.overrideTag || (entry.override ? 'Override' : '');

            // If an override entry provided an explicit date, prefer it for status calculations.
            const entryDateForStatus = effectiveEntry && effectiveEntry.date
              ? (parseISODateOnly(effectiveEntry.date) || dayDate)
              : dayDate;

            const displayStatus = getDisplayStatus(effectiveEntry, now, entryDateForStatus);
            const statusKey = (displayStatus || 'Scheduled').toLowerCase().replace(/\s+/g, '-');
            const reasonText = (effectiveEntry.swapReason || effectiveEntry.reason || effectiveEntry.notes || '').trim();
            const safeReason = reasonText.replace(/"/g, '&quot;');
            const safeOverrideTag = (effectiveOverrideTag || '').replace(/"/g, '&quot;');
            const statusTitleAttr = safeReason ? ` title="${safeReason}"` : (safeOverrideTag ? ` title="${safeOverrideTag}"` : '');
            const overrideTitleAttr = safeReason ? ` title="${safeReason}"` : (safeOverrideTag ? ` title="${safeOverrideTag}"` : '');
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-800/80';
            tr.innerHTML = `
              <td class="py-2 pr-4 align-top ${index === 0 ? 'font-semibold' : ''}">${index === 0 ? day : ''}</td>
              <td class="py-2 pr-4 align-top">${effectiveEntry.start || ''}</td>
              <td class="py-2 pr-4 align-top">${effectiveEntry.end || ''}</td>
              <td class="py-2 pr-4 align-top">${effectiveEntry.subject || ''}</td>
              <td class="py-2 pr-4 align-top">${effectiveEntry.teacher || ''}</td>
              <td class="py-2 pr-4 align-top">${effectiveEntry.room || ''}</td>
              <td class="py-2 pr-4 align-top">
                <span class="status-chip status-chip--${statusKey}"${statusTitleAttr}>${displayStatus}</span>
                ${effectiveOverrideTag ? `<span class="status-chip status-chip--override ml-1"${overrideTitleAttr}>${effectiveOverrideTag}</span>` : ''}
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      }

      function toCSV(section) {
        if (!section || !section.timetable || section.timetable.length === 0) return '';
        const header = ['Section','Day','Start','End','Subject','Teacher','Room','Status'];
        const rows = section.timetable.map(e => [
          section.name,
          e.day || '',
          e.start || '',
          e.end || '',
          e.subject || '',
          e.teacher || '',
          e.room || '',
          e.status || ''
        ]);
        const lines = [header].concat(rows).map(cols => cols.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(','));
        return lines.join('\n');
      }

      function downloadCSV(filename, content) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      fetch('timetable-data.json')
        .then(r => r.json())
        .then(data => {
          sections = data.sections || [];
          overrides = data.overrides || [];
          sections.forEach((s, index) => {
            const opt = document.createElement('option');
            opt.value = s.id || String(index);
            opt.textContent = s.name || ('Section #' + (index + 1));
            sectionSelect.appendChild(opt);
          });
          if (sections.length > 0) {
            const first = sections[0];
            currentSection = first;
            sectionSelect.value = first.id || '0';
            renderTable(first, currentDate);
          }

          // Start a live ticker for the current-period card.
          if (currentPeriodIntervalId) clearInterval(currentPeriodIntervalId);
          currentPeriodIntervalId = setInterval(updateCurrentPeriodCard, 1000);
          updateCurrentPeriodCard();
        })
        .catch(err => {
          console.error('Failed to load timetable-data.json', err);
          tbody.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-red-400">Unable to load timetable data.</td></tr>';
        });

      sectionSelect.addEventListener('change', function() {
        const id = this.value;
        currentSection = sections.find(s => (s.id || '') === id) || null;
        renderTable(currentSection, currentDate);
        updateCurrentPeriodCard();
      });

      dateSelect.addEventListener('change', function() {
        currentDate = this.value || '';
        renderTable(currentSection, currentDate);
        updateCurrentPeriodCard();
      });

      if (viewDailyBtn && viewWeeklyBtn) {
        viewDailyBtn.addEventListener('click', function() {
          viewMode = 'daily';
          updateViewToggleButtons();
          renderTable(currentSection, currentDate);
          updateCurrentPeriodCard();
        });

        viewWeeklyBtn.addEventListener('click', function() {
          viewMode = 'weekly';
          updateViewToggleButtons();
          renderTable(currentSection, currentDate);
          updateCurrentPeriodCard();
        });

        updateViewToggleButtons();
      }

      exportBtn.addEventListener('click', function() {
        if (!currentSection) return;
        const csv = toCSV(currentSection);
        if (!csv) return;
        const safeName = (currentSection.name || 'timetable').replace(/[^a-z0-9]+/gi, '_').toLowerCase();
        downloadCSV(safeName + '.csv', csv);
      });
    })();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }

    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      document.addEventListener('touchstart', function() {}, true);
    }
  </script>
</body>
</html>
