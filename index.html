<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  
  <!-- iOS & Safari Specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TCAS70" />
  
  <!-- Android & Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0b1221" />
  
  <!-- Windows & Microsoft -->
  <meta name="msapplication-TileColor" content="#0b1221" />
  <meta name="msapplication-tap-highlight" content="no" />
  
  <!-- Touch Icons -->
  <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180?text=TCAS70" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <title>TCAS70 Dashboard (React)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kanit:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="sidebar-loader.js" defer></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            display: ['Kanit', 'Inter', 'ui-sans-serif'],
          },
          colors: {
            neonPink: '#ff3fa4',
            neonBlue: '#33e1ff',
          },
          boxShadow: {
            glow: '0 0 30px rgba(255,63,164,0.35)',
            glowBlue: '0 0 30px rgba(51,225,255,0.35)'
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function formatDate(d) {
      if (!d) return '';
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function formatTime(d) {
      if (!d) return '';
      return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }
    function formatDateTime(d) {
      if (!d) return '';
      return `${formatDate(d)} ${formatTime(d)}`;
    }
    function parseEventDate(e) {
      if (!e) return null;
      if (e.isTest && e.testTime) return new Date(e.testTime);
      return new Date(`${e.date}T00:00:00`);
    }
    function diffParts(target, now) {
      if (!target) return { d: '00', h: '00', m: '00', s: '00', showDays: false, done: true };
      const ms = target - now;
      if (ms <= 0) return { d: '00', h: '00', m: '00', s: '00', showDays: false, done: true };
      const totalSec = Math.floor(ms / 1000);
      const days = Math.floor(totalSec / 86400);
      const h = Math.floor((totalSec % 86400) / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      return {
        d: String(days).padStart(2, '0'),
        h: String(h).padStart(2, '0'),
        m: String(m).padStart(2, '0'),
        s: String(s).padStart(2, '0'),
        showDays: days > 0,
        done: false,
      };
    }

    function App() {
      const [faculties, setFaculties] = useState([]);
      const [selectedFacultyName, setSelectedFacultyName] = useState('');
      const [activeTarget, setActiveTarget] = useState(null);
      const [countdownLabel, setCountdownLabel] = useState('');
      const [now, setNow] = useState(new Date());
      const [showTimeline, setShowTimeline] = useState(true);
        const [showCountdownFullscreen, setShowCountdownFullscreen] = useState(false);
      const [userSelectedTarget, setUserSelectedTarget] = useState(false);

      useEffect(() => {
        fetch('data.json', { cache: 'no-store' })
          .then((r) => r.json())
          .then((data) => {
            setFaculties(data.faculties || []);
            if ((data.faculties || []).length) {
              setSelectedFacultyName(data.faculties[0].name);
            }
          })
          .catch((e) => console.error('Failed to load data.json', e));
      }, []);

      useEffect(() => {
        const id = setInterval(() => setNow(new Date()), 1000);
        return () => clearInterval(id);
      }, []);

      const selectedFaculty = useMemo(() => {
        return faculties.find((f) => f.name === selectedFacultyName) || null;
      }, [faculties, selectedFacultyName]);

      const upcomingEvents = useMemo(() => {
        if (!selectedFaculty) return [];
        return (selectedFaculty.timeline || [])
          .map((e) => ({ ...e, _dt: parseEventDate(e) }))
          .filter((e) => e._dt && e._dt > now)
          .sort((a, b) => a._dt - b._dt);
      }, [selectedFaculty, now]);

      const upcomingEligibleEvents = useMemo(() => {
        return upcomingEvents.filter((e) => e.countdownEligible);
      }, [upcomingEvents]);

      useEffect(() => {
        if (upcomingEligibleEvents.length) {
          if (!userSelectedTarget) {
            const e = upcomingEligibleEvents[0];
            setActiveTarget(e._dt);
            setCountdownLabel(`${e.task} ‚Äî ${formatDateTime(e._dt)}`);
          }
        } else {
          setActiveTarget(null);
          setCountdownLabel('');
          setUserSelectedTarget(false);
        }
      }, [selectedFacultyName, upcomingEligibleEvents, userSelectedTarget]);

      useEffect(() => {
        // Reset manual selection when faculty changes
        setUserSelectedTarget(false);
      }, [selectedFacultyName]);

      function setEventTarget(e) {
        const d = parseEventDate(e);
        if (!d) return;
        setActiveTarget(d);
        setCountdownLabel(`${e.task} ‚Äî ${formatDateTime(d)}`);
        setUserSelectedTarget(true);
      }

      const parts = diffParts(activeTarget, now);

      return (
        <div className="relative min-h-screen">

          {/* Header */}
          <header className="relative max-w-7xl mx-auto px-4 md:px-8 pt-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <h1 className="text-3xl md:text-4xl font-[Kanit] font-bold text-white">Time till TCAS70</h1>
              <div className="flex flex-wrap gap-3 items-center">
                <label className="text-sm text-slate-300">Faculty</label>
                <select value={selectedFacultyName} onChange={(e)=>setSelectedFacultyName(e.target.value)} className="glass text-white border border-slate-700/60 rounded-lg px-4 py-2 bg-slate-900/60 focus:outline-none focus:ring-2 focus:ring-neonPink focus:border-neonPink">
                  {faculties.map(f => (
                    <option key={f.name} value={f.name} className="bg-slate-900">{f.name}</option>
                  ))}
                </select>
                <button onClick={()=>setShowTimeline(v=>!v)} className="px-4 py-2 rounded-lg text-sm font-semibold border border-slate-700 text-white hover:border-neonBlue transition" aria-label="Toggle timeline">üóÇ</button>
                <button onClick={()=>window.forceReloadFromOrigin && window.forceReloadFromOrigin()} className="px-4 py-2 rounded-lg text-sm font-semibold border border-slate-700 text-white hover:border-neonPink transition" aria-label="Force refresh from origin">‚Üª</button>
              </div>
            </div>
          </header>

          {/* Main content */}
          <main className="relative max-w-7xl mx-auto px-4 md:px-8 py-6 space-y-8">
            <div className={`grid gap-6 items-stretch ${showTimeline ? 'md:grid-cols-[2fr,1fr]' : 'grid-cols-1'}`}>
              {/* Countdown card */}
              <section className="glass rounded-3xl p-6 md:p-10 shadow-glowBlue border border-slate-800/80 h-full flex flex-col">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div>
                    <p className="text-slate-400 text-sm">Counting down to</p>
                    <h2 className="text-xl md:text-2xl font-semibold text-white">{countdownLabel || 'No eligible upcoming event'}</h2>
                  </div>
                    <div className="text-right flex flex-col items-end gap-2">
                      <div>
                        <p className="text-xs text-slate-500 uppercase tracking-[0.2em]">Live Sync</p>
                        <p className="text-base font-semibold text-neonBlue">{formatDateTime(now)}</p>
                      </div>
                      <button
                        type="button"
                        onClick={() => setShowCountdownFullscreen(true)}
                        className="px-3 py-1 rounded-full border border-slate-700 text-xs text-white hover:border-neonBlue transition"
                        aria-label="Show countdown fullscreen"
                      >‚õ∂ Fullscreen</button>
                    </div>
                </div>

                <div className="mt-8 flex items-center justify-center">
                  <div className="font-[Kanit] font-extrabold countdown-digits select-none">
                    <div className="text-6xl sm:text-7xl md:text-8xl lg:text-9xl tracking-tight">
                      {parts.showDays && (<><span>{parts.d}</span><span className="mx-2">:</span></>)}
                      <span>{parts.h}</span><span className="mx-2">:</span><span>{parts.m}</span><span className="mx-2">:</span><span>{parts.s}</span>
                    </div>
                  </div>
                </div>
              </section>

              {/* Timeline */}
              {showTimeline && (
                <aside className="glass rounded-3xl p-6 shadow-glow border border-slate-800/80 order-last md:order-none h-full flex flex-col">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-semibold text-white">Timeline</h3>
                    <span className="text-xs uppercase tracking-[0.2em] text-neonPink">{selectedFacultyName || '‚Äî'}</span>
                  </div>
                  <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2 timeline-list flex-1">
                    {upcomingEvents.length === 0 && (
                      <div className="text-white/60">No upcoming events</div>
                    )}
                    {upcomingEvents.map((e, idx) => (
                      <div key={idx} className="relative timeline-dot pl-5 flex items-start justify-between gap-2 p-2 rounded hover:bg-white/5">
                        <div>
                          <p className="text-sm text-slate-400">{formatDate(e._dt)} {e.isTest && e.testTime ? `‚Ä¢ ${formatTime(e._dt)}` : ''}</p>
                          <p className="text-base font-semibold text-white">{e.task}</p>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-xs px-2 py-1 rounded-full border border-slate-700 text-slate-400">{e.countdownEligible ? 'Countdown' : 'Info'}</span>
                          <button
                            type="button"
                            disabled={!e.countdownEligible}
                            className={`text-xs px-3 py-1 rounded-full ${e.countdownEligible ? 'bg-gradient-to-r from-neonPink to-neonBlue text-slate-900 font-semibold hover:shadow-glowBlue transition' : 'bg-slate-700 text-white border border-slate-500 opacity-50 cursor-not-allowed'}`}
                            onClick={() => setEventTarget(e)}
                            title={e.countdownEligible ? 'Set as countdown' : 'Not eligible for countdown'}
                          >‚è±Ô∏è</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </aside>
              )}
            </div>
              {showCountdownFullscreen && (
                <div className="fixed inset-0 z-50 bg-slate-950/95 flex flex-col items-center justify-center px-4">
                  <button
                    type="button"
                    onClick={() => setShowCountdownFullscreen(false)}
                    className="absolute top-4 right-4 px-3 py-1 rounded-full border border-slate-700 text-xs text-white hover:border-neonPink transition"
                    aria-label="Close fullscreen countdown"
                  >‚úï</button>
                  <div className="max-w-3xl w-full text-center space-y-6">
                    <div>
                      <p className="text-slate-400 text-sm">Counting down to</p>
                      <h2 className="text-2xl md:text-3xl font-semibold text-white break-words">{countdownLabel || 'No eligible upcoming event'}</h2>
                    </div>
                    <div className="font-[Kanit] font-extrabold countdown-digits select-none">
                      <div className="text-6xl sm:text-7xl md:text-8xl lg:text-9xl xl:text-[8rem] tracking-tight">
                        {parts.showDays && (<><span>{parts.d}</span><span className="mx-2">:</span></>)}
                        <span>{parts.h}</span><span className="mx-2">:</span><span>{parts.m}</span><span className="mx-2">:</span><span>{parts.s}</span>
                      </div>
                    </div>
                    <p className="text-xs text-slate-500 uppercase tracking-[0.2em]">Live Sync {formatDateTime(now)}</p>
                  </div>
                </div>
              )}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  
  <!-- Service Worker Registration -->
  <script>
    // Register service worker for offline support and PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }

    // Force reload all components from site origin.
    window.forceReloadFromOrigin = async function forceReloadFromOrigin() {
      try {
        if ('serviceWorker' in navigator) {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            await registration.update();
          }

          const target = (registration && (registration.waiting || registration.active)) || navigator.serviceWorker.controller;
          if (target) {
            const channel = new MessageChannel();
            const done = new Promise((resolve) => {
              channel.port1.onmessage = () => resolve();
              setTimeout(resolve, 2500);
            });
            target.postMessage({ type: 'FORCE_REFRESH' }, [channel.port2]);
            await done;
          }
        }
      } catch (e) {
        // best-effort
      }

      const base = location.pathname || '/';
      const qs = new URLSearchParams(location.search);
      qs.set('_cb', String(Date.now()));
      location.replace(base + '?' + qs.toString());
    };

    // Auto-update at the top of every hour.
    (function scheduleTopOfHourRefresh() {
      const now = new Date();
      const next = new Date(now);
      next.setMinutes(0, 0, 0);
      next.setHours(now.getHours() + 1);
      const ms = Math.max(1000, next.getTime() - now.getTime());
      setTimeout(() => {
        if (window.forceReloadFromOrigin) {
          window.forceReloadFromOrigin();
        }
      }, ms);
    })();
    
    // iOS Safari click fix - ensures buttons work properly
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      document.addEventListener('touchstart', function() {}, true);
    }
  </script>
</body>
</html>
